---
title: "LEHD LODES"
subtitle: "Eastern Shore Region 2018 Data"
author: "Lee LeBoeuf"
date: "07/20/2021"
output: 
  html_document:
    toc: yes
    toc_float: true
---

## Eastern Shore region 2018 LODE data exploration

```{r libraries, include=FALSE}
source('https://raw.githubusercontent.com/jacob-gg/manager/main/R/loch_missingness_monster.R')
invisible(lapply(list('tidyverse', 'stargazer', 'janitor', 'tigris', 'sf', 'leaflet', 'rcartocolor', 
                      'RColorBrewer', 'viridis', 'rgdal', 'lodes', 'psych', 'reshape2', 'googlesheets4', 'sp'),
                 function(pkg) library(pkg, character.only = TRUE)))
lodes <- read.csv("lodes_employment_eastern_block.csv")
meta <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit?usp=sharing", sheet = "lehd_lodes", gs4_deauth())
```

## Data source 
* Data structure description: https://lehd.ces.census.gov/data/lodes/LODES7/LODESTechDoc7.5.pdf
* Data download: https://lehd.ces.census.gov/data/lodes/LODES7/va/
* Helpful article about how these data are collected and how they can be used: https://www.researchgate.net/publication/328700665_The_US_Census_Longitudinal_Employer-Household_Dynamics_Datasets

## Data specifics
* The Longitudinal Employer Household Dynamics (LEHD) program at the US Census Bureau releases the Origin Destination Employment Statistis (LODES) datasets annually based on employer-employee insurance records. 
* This data file uses data from the Workplace Area Characteristics (WAC) and the Resident Area Characteristics (RAC) datafiles from LEHD.  
* Data presented here are from 2018 and spatial units are based on the 2010 census. As of July of 2021, 2018 is the most recent year for which data are available. The earliest year for which data are available is 2002. 
* The data contains the number of jobs within a spatial unit (SU), disaggregated by wage earnings, education-attainment of the worker, and race of the worker (all of which were pulled from the WAC data file)
* Some limitations: jobs counts do not include those working in defense-related industries; the data are prone to imperfect geocoding for certain jobs (jobs for companies with multiple branches are often all coded in the same location); although there are datasets from 2002-2018, these data are not suitable for longitudinal analysis; and student-workers are unlikely to be represented in these data because their jobs are not typically covered by state unemployment insurance.

## Variable descriptions
```{r}
meta %>% 
  filter(su_block == 1) %>%
  select(varname, about) %>% as.list()
glimpse(lodes)
lodes %>% select(lowwage_jobs:resid_jobs_ratio) %>% 
  select(where(~is.numeric(.x))) %>% 
  as.data.frame() %>% 
  stargazer(., type = "text", title = "Summary Statistics", digits = 2,
            summary.stat = c("mean", "sd", "min", "median", "max"))
loch_missingness_monster(lodes)
```
* Most of the missing data comes from missing residential data. 

## Total jobs counts
```{r}
lodes %>% select(c(w_geocode:alljobs, residents, resid_jobs_ratio)) %>% 
  pivot_longer(-w_geocode, names_to = "measure", values_to = "value") %>% 
  ggplot(aes(x = value, fill = measure)) + 
  scale_fill_viridis(option = "plasma", discrete = TRUE, guide = FALSE) +
  geom_histogram() + 
  facet_wrap(~measure, scales = "free")
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("higwage_jobs", "lowwage_jobs", "midwage_jobs", "alljobs", "resid_jobs_ratio")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
```

## Mapping the data 
```{r, echo = FALSE}
shape <- readRDS('eastshore_blocks.RDS')
shape <- st_transform(shape, crs = 4326) # to WGS84, given error
shape <- shape %>% dplyr::rename(w_geocode = GEOID10)
is.element(lodes$w_geocode, shape$w_geocode) %>%
  all()
east_lodes <- merge(shape, lodes, by = 'w_geocode', all.x = T)
```

### All jobs
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = east_lodes$alljobs)
leaflet(east_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = east_lodes,
              fillColor = ~pal(alljobs),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", east_lodes$w_geocode, "<br>",
                             "Number of jobs: ", east_lodes$alljobs, 2)) %>% 
  addLegend("bottomright", pal = pal, values = east_lodes$alljobs, 
            title = "Number of jobs", opacity = 0.7)
```

### Ratio of residents to jobs
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = east_lodes$resid_jobs_ratio)
leaflet(east_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = east_lodes,
              fillColor = ~pal(resid_jobs_ratio),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", east_lodes$w_geocode, "<br>",
                             "Resident to jobs ratio: ", round(east_lodes$resid_jobs_ratio, 2))) %>% 
  addLegend("bottomright", pal = pal, values = east_lodes$resid_jobs_ratio, 
            title = "Ratio of residents to jobs", opacity = 0.7)
```

### Block type categories
```{r}
pal <- colorFactor("plasma", reverse = TRUE, domain = east_lodes$blocktype)
leaflet(east_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = east_lodes,
              fillColor = ~pal(blocktype),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", east_lodes$w_geocode, "<br>",
                             "Block Type: ", east_lodes$blocktype, "<br>",
                             "Number of residents: ", east_lodes$residents, "<br>",
                             "Number of jobs: ", east_lodes$alljobs)) %>% 
  addLegend("bottomright", pal = pal, values = east_lodes$blocktype, 
            title = "Block Type", opacity = 0.7)
```

### Wages

#### Proportion of low-wage jobs (earnings $1250/month or less) in each SU

```{r}
pal <- colorNumeric("BuPu", domain = east_lodes$lowwage_p)
leaflet(east_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = east_lodes,
              fillColor = ~pal(lowwage_p),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
                ),
              popup = paste0("GEOID: ", east_lodes$w_geocode, "<br>",
               "Prop. low-wage jobs: ", round(east_lodes$lowwage_p, 2))) %>% 
  addLegend("bottomright", pal = pal, values = east_lodes$lowwage_p, 
            title = "Proportion of low wage jobs", opacity = 0.7)
```

#### Proportion of high-wage jobs (earnings greater than $3333/month) in each SU

```{r}
pal <- colorNumeric("BuPu", domain = east_lodes$higwage_p)
leaflet(east_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = east_lodes,
              fillColor = ~pal(higwage_p),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              smoothFactor = 0.3,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", east_lodes$w_geocode, "<br>",
                             "Prop. high-wage jobs: ", round(east_lodes$higwage_p, 2))) %>% 
  addLegend("bottomright", pal = pal, values = east_lodes$higwage_p, 
            title = "Proportion of high-wage jobs", opacity = 0.7)
```

### Education

#### Number of jobs for college-educated workers in each SU

```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = east_lodes$Bach_AdvDeg_jobs)
leaflet(east_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = east_lodes,
              fillColor = ~pal(Bach_AdvDeg_jobs),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              smoothFactor = 0.3,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", east_lodes$w_geocode, "<br>",
                             "Number of jobs: ", east_lodes$Bach_AdvDeg_jobs)) %>% 
  addLegend("bottomright", pal = pal, values = east_lodes$Bach_AdvDeg_jobs, 
            title = "Number of jobs for college-educated workers", opacity = 0.7)
```



