title: "FEMA NFIP Claims --Eastern Shore"
author: "Khalila Karefa-Kargbo"
date: "07/07/2021"
```{r}
library(tidyverse)
library(mosaic)
library(stargazer)
library(googlesheets4)
library(sf)
library(viridis)
library(leaflet)
```

# Get Data
Source: FEMA, NFIP Redacted Claims, last updated July 2020
* Source URL: [https://www.fema.gov/openfema-data-page/fima-nfip-redacted-claims]
* Download URL: [https://www.fema.gov/api/open/v1/FimaNfipClaims.csv]

```{r}
easternAmountPaidByTract <- read_csv("fema_nfip_eastern_tract.csv")
meta <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit#gid=5733069", sheet = 'fema_nfip')
```

# Exploration
```{r}
glimpse(easternAmountPaidByTract)
# 417 total observations in the eastern shore
```

**Variables of Interest:** Number of flood claims in spatial unit & total amount paid on flood claims in spatial unit: goal: understanding the degree of damage experienced in a place

**Variable Descriptions:**
```{r}
meta %>%
  select(c(varname, about)) %>% 
  as.list()
```

# Visual distributions
```{r}
# barplot of the total $ amount paid by census tract
ggplot(easternAmountPaidByTract) + 
  geom_col(aes(x=as.factor(censusTract), y=totalAmountPaid)) +
  coord_flip() +
  labs(x="Census Tract",
       y="$ Amount Paid",
       title="Total Building & Contents Claim Amount Paid by Census Tract")
```

```{r}
# barplot of the total insurance coverage amount by census tract
ggplot(easternAmountPaidByTract) + 
  geom_col(aes(x=as.factor(censusTract), y=totalInsuranceCoverage)) +
  coord_flip() +
  labs(x="Census Tract",
       y="Insurance Coverage (in $)",
       title="Insurance Coverage Amount by Census Tract")
```

# Maps 
**Get Data**
```{r}
eastshore_tracts <- readRDS("data/eastshore_tracts.RDS")

easternAmountPaidByTract <- easternAmountPaidByTract %>% 
  mutate(TRACT = str_sub(censusTract, 6,11),
    TRACT = as.character(TRACT))

eastern_amount <- eastshore_tracts %>% 
  left_join(easternAmountPaidByTract, by = c("TRACTCE" = "TRACT"))

eastern_amount <- st_transform(eastern_amount, crs = 4326) # to WGS84, given error
```

**Number of Claims per Census Tract**
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = eastern_amount$n) # viridis

leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = eastern_amount,
              fillColor = ~pal(n),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.8,
                bringToFront = T
              ),
              popup = paste0("Tract Number: ", eastern_amount$NAME, "<br>",
                             "Number: ", round(eastern_amount$n, 2))
  ) %>% 
  addLegend("bottomright", pal = pal, values = eastern_amount$n, 
            title = "# FEMA Claims", opacity = 0.7)
```

**Total Insurance Amount Map**
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = eastern_amount$totalInsuranceCoverage) # viridis

leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = eastern_amount,
              fillColor = ~pal(totalInsuranceCoverage),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.8,
                bringToFront = T
              ),
              popup = paste0("Tract Number: ", eastern_amount$NAME, "<br>",
                             "$ Amount: ", round(eastern_amount$totalInsuranceCoverage, 2))
  ) %>% 
  addLegend("bottomright", pal = pal, values = eastern_amount$totalInsuranceCoverage, 
            title = "Insurace Coverage Amount", opacity = 0.7)
```

**Total Claim Amount Map**
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = eastern_amount$totalAmountPaid) # viridis

leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = eastern_amount,
              fillColor = ~pal(totalAmountPaid),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.8,
                bringToFront = T
              ),
              popup = paste0("Tract Number: ", eastern_amount$NAME, "<br>",
                             "$ Amount: ", round(eastern_amount$totalAmountPaid, 2))
  ) %>% 
  addLegend("bottomright", pal = pal, values = eastern_amount$totalAmountPaid, 
            title = "Claim Amount Paid", opacity = 0.7)
```

# Miscellaneous

**Other potential variables of interest (from original dataset):**
- **elevatedBuildingIndicator:** Yes (Y) or No (N) indicator of whether or not a building meets the NFIP definition of an elevated building (does not meet this criteria --> higher chance for flood damage)
- **floodZone:** derived from the Flood Insurance Rate Map (FIRM) used to rate the insured property (ie. how susceptible to flood damage they are)


[This](https://www.fema.gov/about/openfema/data-sets#misc) is a list of all of FEMA's open data sets and could be helpful

[claim manual](https://www.fema.gov/sites/default/files/2020-07/fema_nfip_claims-manual_2020.pdf) that gives a little more details on how claims are filed (might not be that helpful though)
