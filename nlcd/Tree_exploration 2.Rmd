---
title: "Tree Canopy Exploration"
author: "Helena Lindsay"
date: "7/7/2021"
output:
  html_document: 
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
```


### National Land Cover Database (NLCD)
Data Source: https://www.mrlc.gov/data?f%5B0%5D=category%3ATree%20Canopy&f%5B1%5D=region%3Aconus

Data description: https://www.mrlc.gov/sites/default/files/TCC_Project_Overview_Brochure-MRLC_2020-06-05.pdf

About the source [Multi-Resolution Land Characteristics (MRLC) consortium]: https://www.mrlc.gov/about

Tree canopy cover (TCC) is the layer of tree leaves, needles, branches, and stems that provide tree coverage of the ground, viewed from an aerial perspective. The TCC maps represent canopy cover values, ranging from 0 to 100, for a 30 meter cell.

Automated classification techniques were used to produce tree canopy cover estimates. Forest Inventory and Analysis (FIA) plots were photo-interpreted for tree canopy cover using high resolution imagery and used to generate over 65,000 reference sites. Approximately 9,000 individual Landsat scenes, their spectral derivatives, harmonic regression coe cients, topographic data, and the reference sites were used as input data in the modeling procedure.

The data was retrieved using the FedData library, get_nlcd function. The function returns a RasterLayer of the three categories of NLCD data (tree canopy, impervious surfaces, landcover) cropped to a given template study area. In this project, we pulled the tree canopy data on tract, block and blockgroup levels for the designated locations around Virginia.


```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(leaflet)
library(sp)
library(viridis)
library(raster)
library(knitr)
library(dplyr)
library(kableExtra)
```



## Charlottesville Region {.tabset}

```{r, message=F, warning=F}
cville_tracts <- readRDS("Cville_Tree/cville_tracts.RDS")
cville_blkgps <- readRDS("Cville_Tree/cville_blkgps.RDS")
cville_blocks <- readRDS("Cville_Tree/cville_blocks.RDS")
cvillefips <- c("540", "3", "65", "79", "109", "125")
```

### Counties

```{r, include=FALSE}
cvl_tracts <- read.csv("Cville_Tree/nlcd_tree_cville_tracts.csv")%>%
  dplyr::select(-c(5,7,8))

cvl_tracts <- cvl_tracts[order(cvl_tracts$TRACTCE), ]

cvl_tracts$COUNTYFP[cvl_tracts$COUNTYFP == 3] <- 1
cvl_tracts$COUNTYFP[cvl_tracts$COUNTYFP == 65] <- 2
cvl_tracts$COUNTYFP[cvl_tracts$COUNTYFP == 79] <- 3
cvl_tracts$COUNTYFP[cvl_tracts$COUNTYFP == 109] <- 4
cvl_tracts$COUNTYFP[cvl_tracts$COUNTYFP == 125] <- 5
cvl_tracts$COUNTYFP[cvl_tracts$COUNTYFP == 540] <- 6
```

```{r, message=F, warning=FALSE}
ggplot(cvl_tracts, aes(x=COUNTYFP, y=tree_can)) +
        geom_point(shape=1) +
  geom_density_2d_filled(size = 0.25, alpha = 0.5)+
  scale_x_discrete(cvl_tracts$COUNTYFP, name ="COUNTYFP", labels= c("1" = "3", "2" ="65", "3" ="79", "4"="109", "5"="125", "6"="540"), breaks=c(1, 2, 3, 4, 5, 6))

```


### Tracts
```{r, message=F, warning=FALSE}

kable(head(cvl_tracts))%>%
  kable_styling(font_size = 12)
```

```{r, message=F, warning=FALSE}
ggplot(cvl_tracts) + 
  geom_col(aes(x=as.factor(GEOID), y=tree_can)) +
  coord_flip() +
  labs(x="GEOID",
       y="% Tree Canopy",
       title="% Tree Canopy by GEOID")+
  theme(axis.text.y = element_text(face="plain", color="black", 
                           size=5))
```

```{r, message=F, warning=FALSE}
cville_tracts$tree_can <- cvl_tracts$tree_can


pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_tracts$tree_can)
cvl_tracts$tree_can <- as.numeric(cvl_tracts$tree_can)
cville_tracts$COUNTYFP <- as.numeric(cville_tracts$COUNTYFP)
m <- leaflet()%>%
  addTiles()%>%
  addPolygons(data = cville_tracts,
              fillColor = ~pal(tree_can),
              weight = 1,
              opacity = 1,
              color = "white",
              fillOpacity = 0.6,
              highlight = highlightOptions(weight = 2, fillOpacity = 0.8, bringToFront = T),
              popup = paste0("FIPS Code: ", cvl_tracts$GEOID, "<br>",
                             "Tree Canopy: ", cvl_tracts$tree_can,"<br>",
                             "Tract: ", cvl_tracts$NAMELSAD)) %>%
  addLegend("bottomright", pal = pal, values = cvl_tracts$tree_can,
            title = "Tree Canopy", opacity = 0.7)
m
```





### Blockgroups
```{r, message=F, warning=F}
cvl_blkgps <- read.csv("Cville_Tree/nlcd_tree_cville_blkgps.csv")%>%
  as.data.frame()

cvl_blkgps <- cvl_blkgps[order(cvl_blkgps$TRACTCE), ]

kable(head(cvl_blkgps))%>%
  kable_styling(font_size = 12)


cville_blkgps$tree_can <- cvl_blkgps$tree_can


pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_blkgps$tree_can)
cvl_blkgps$tree_can <- as.numeric(cvl_blkgps$tree_can)
cville_blkgps$COUNTYFP <- as.numeric(cville_blkgps$COUNTYFP)
m <- leaflet()%>%
  addTiles()%>%
  addPolygons(data = cville_blkgps,
              fillColor = ~pal(tree_can),
              weight = 1,
              opacity = 1,
              color = "white",
              fillOpacity = 0.6,
              highlight = highlightOptions(weight = 2, fillOpacity = 0.8, bringToFront = T),
              popup = paste0("FIPS Code: ", cvl_blkgps$GEOID, "<br>",
                             "Tree Canopy: ", cvl_blkgps$tree_can,"<br>",
                             "Blockgroup: ", cvl_blkgps$NAMELSAD)) %>%
  addLegend("bottomright", pal = pal, values = cvl_blkgps$tree_can,
            title = "Tree Canopy", opacity = 0.7)
m

```


### Blocks
```{r, message=F, warning=FALSE}
cvl_blocks <- read.csv("Cville_Tree/nlcd_tree_cville_blocks.csv")%>%
  as.data.frame()

kable(head(cvl_blocks))%>%
  kable_styling(font_size = 12)


cville_blocks$tree_can <- cvl_blocks$tree_can

pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_blocks$tree_can)
cvl_blocks$tree_can <- as.numeric(cvl_blocks$tree_can)
cville_blocks$COUNTYFP <- as.numeric(cville_blocks$COUNTYFP)
m <- leaflet()%>%
  addTiles()%>%
  addPolygons(data = cville_blocks,
              fillColor = ~pal(tree_can),
              weight = 1,
              opacity = 1,
              color = "white",
              fillOpacity = 0.6,
              highlight = highlightOptions(weight = 2, fillOpacity = 0.8, bringToFront = T),
              popup = paste0("FIPS Code: ", cvl_blocks$GEOID, "<br>",
                             "Tree Canopy: ", cvl_blocks$tree_can,"<br>",
                             "Block: ", cvl_blocks$NAME10)) %>%
  addLegend("bottomright", pal = pal, values = cvl_blocks$tree_can,
            title = "Tree Canopy", opacity = 0.7)
m
```


## Eastern Shore Region {.tabset}

```{r, message=F, warning=F}
east_tracts <- readRDS("Easternshore_Tree/eastshore_tracts.RDS")
east_blkgps <- readRDS("Easternshore_Tree/eastshore_blkgps.RDS")
east_blocks <- readRDS("Easternshore_Tree/eastshore_blocks.RDS")
```

### Counties
```{r, include=FALSE}
eastern_tracts <- read.csv("Easternshore_Tree/nlcd_tree_eastshore_tracts.csv")%>%
  as.data.frame()
eastern_tracts$tree_can <- round(eastern_tracts$tree_can,3)
eastern_tracts$COUNTYFP[eastern_tracts$COUNTYFP == 1] <- 1
eastern_tracts$COUNTYFP[eastern_tracts$COUNTYFP == 131] <- 2

```

```{r, message=F, warning=FALSE}

ggplot(eastern_tracts, aes(x=COUNTYFP, y=tree_can)) +
  geom_point(shape=1) +
  geom_density_2d_filled(size = 0.25, alpha = 0.5) +
  scale_x_continuous(eastern_tracts$COUNTYFP, name ="COUNTYFP", labels= c("1" = "1", "2" ="131"), breaks=c(1, 2))

```

### Tracts
```{r, include=FALSE}

eastern_tracts$TRACTCE <- as.numeric(eastern_tracts$TRACTCE)
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090200] <- 1
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 980200] <- 2
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 980100] <- 3
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090400] <- 4
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 990100] <- 5
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 930300] <- 6
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 930200] <- 7
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090300] <- 8
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090800] <- 9
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 990200] <- 10
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090600] <- 11
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090500] <- 12
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090700] <- 13
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 930100] <- 14
eastern_tracts$TRACTCE[eastern_tracts$TRACTCE == 090100] <- 15

```

```{r, message=F, warning=FALSE}

ggplot(eastern_tracts) + 
  geom_col(aes(x=as.factor(GEOID), y=tree_can)) +
  coord_flip() +
  labs(x="GEOID",
       y="% Tree Canopy",
       title="% Tree Canopy by GEOID")+
  theme(axis.text.y = element_text(face="plain", color="black", 
                           size=6))


```

```{r, message=F, warning=FALSE}
kable(head(eastern_tracts))%>%
  kable_styling(font_size = 12)

east_tracts$tree_can <- eastern_tracts$tree_can

pal <- colorNumeric("plasma", reverse = TRUE, domain = eastern_tracts$tree_can)
east_tracts$COUNTYFP <- as.numeric(east_tracts$COUNTYFP)
m <- leaflet()%>%
  addTiles()%>%
  addPolygons(data = east_tracts,
              fillColor = ~pal(tree_can),
              weight = 1,
              opacity = 1,
              color = "white",
              fillOpacity = 0.6,
              highlight = highlightOptions(weight = 2, fillOpacity = 0.8, bringToFront = T),
              popup = paste0("FIPS Code: ", eastern_tracts$GEOID, "<br>",
                             "Tree Canopy: ", eastern_tracts$tree_can, "<br>",
                             "Tract: ", eastern_tracts$NAMELSAD)) %>%
  addLegend("bottomright", pal = pal, values = eastern_tracts$tree_can,
            title = "Tree Canopy", opacity = 0.7)
m
```


### Blockgroups
```{r, message=F, warning=FALSE}
eastern_blkgps <- read.csv("Easternshore_Tree/nlcd_tree_eastshore_blkgps.csv")%>%
  as.data.frame()

kable(head(eastern_blkgps))%>%
  kable_styling(font_size = 12)

# cvl_tracts <- cvl_tracts[complete.cases(cvl_tracts),]

east_blkgps$tree_can <- eastern_blkgps$tree_can

pal <- colorNumeric("plasma", reverse = TRUE, domain = eastern_blkgps$tree_can)
eastern_blkgps$tree_can <- as.numeric(eastern_blkgps$tree_can)
east_blkgps$COUNTYFP <- as.numeric(east_blkgps$COUNTYFP)
m <- leaflet()%>%
  addTiles()%>%
  addPolygons(data = east_blkgps,
              fillColor = ~pal(tree_can),
              weight = 1,
              opacity = 1,
              color = "white",
              fillOpacity = 0.6,
              highlight = highlightOptions(weight = 2, fillOpacity = 0.8, bringToFront = T),
              popup = paste0("FIPS Code: ", eastern_blkgps$GEOID, "<br>",
                             "Tree Canopy: ", eastern_blkgps$tree_can, "<br>",
                             "Blockgroup: ", eastern_blkgps$NAMELSAD)) %>%
  addLegend("bottomright", pal = pal, values = eastern_blkgps$tree_can,
            title = "Tree Canopy", opacity = 0.7)
m
```

### Blocks
```{r, message=F, warning=FALSE}
eastern_blocks <- read.csv("Easternshore_Tree/nlcd_tree_eastshore_blocks.csv")%>%
  as.data.frame()

kable(head(eastern_blocks))%>%
  kable_styling(font_size = 12)

east_blocks$tree_can <- eastern_blocks$tree_can

pal <- colorNumeric("plasma", reverse = TRUE, domain = eastern_blocks$tree_can)
eastern_blocks$tree_can <- as.numeric(eastern_blocks$tree_can)
east_blocks$COUNTYFP <- as.numeric(east_blocks$COUNTYFP)
m <- leaflet()%>%
  addTiles()%>%
  addPolygons(data = east_blocks,
              fillColor = ~pal(tree_can),
              weight = 1,
              opacity = 1,
              color = "white",
              fillOpacity = 0.6,
              highlight = highlightOptions(weight = 2, fillOpacity = 0.8, bringToFront = T),
              popup = paste0("FIPS Code: ", eastern_blocks$GEOID, "<br>",
                             "Tree Canopy: ", eastern_blocks$tree_can, "<br>",
                             "Blocks: ", eastern_blocks$Tree_can)) %>%
  addLegend("bottomright", pal = pal, values = eastern_blocks$tree_can,
            title = "Tree Canopy", opacity = 0.7)
m
```







