---
title: "Data review file"
author: "Helena Lindsay"
date: "7/1/2021"
output:
  html_document: 
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Data from get_nlcd() 
Data source: https://www.mrlc.gov/

Data was retrieved using the FedData library, get_nlcd function. The function returns a RasterLayer of NLCD data cropped to a given template study area. In this project, we pulled the impervious surfaces and tree canopy data to then analyze based on different tracts, blocks in various locations around Virginia.


```{r, warning=FALSE, message=FALSE}
library(FedData) 
library(tigris)
library(sf)
library(sp)
library(raster)
library(tidyverse)
```


```{r, include=FALSE}
vacounties <- counties(state="VA")
cvl_alb <- vacounties %>%
  dplyr::filter(COUNTYFP %in% c("003", "540", "065", "079", "109", "125", "001", "131"))
```

### Locations
```{r, figures-side, fig.show="hold", out.width="20%"}
sp::plot(cvl_alb[1,5], main="Charlottesville", col="blue", border=NA) 
sp::plot(cvl_alb[2,5], main="Greene", col="blue", border=NA)
sp::plot(cvl_alb[3,5],  main="Accomack", col="blue", border=NA)
sp::plot(cvl_alb[4,5], main="Albemarle", col="blue", border=NA)
sp::plot(cvl_alb[5,5], main="Nelson", col="blue", border=NA)
sp::plot(cvl_alb[6,5], main= "Fluvanna", col="blue", border=NA)
sp::plot(cvl_alb[7,5], main = "Louisa", col="blue", border=NA)
sp::plot(cvl_alb[8,5], main="Northampton", col="blue", border=NA)

```

```{r, include=F}
cvltracts <- tracts(state = "VA", county = "540")
```

## Tree Canopy 
### Charlottesville {.tabset}
```{r, warning=FALSE, message=FALSE, out.width="40%"}
tree <- get_nlcd(
  template = cvltracts,
  label = "Charlottesville",
  dataset = "Tree_Canopy",
  year = 2016, 
  landmass = "L48"
)

plot(tree)
```

#### Tracts

```{r, include=F}
# Convert raster to df
tree_df <- as.data.frame(tree, xy = TRUE)
names(tree_df) <- c("x", "y", "tree_can")

ggplot(tree_df, aes(x = tree_can)) + geom_histogram()

# reproject polygons to same CRS as tree
crs(tree)
cvltracts <- st_transform(cvltracts, projection(tree))
```

```{r, warning=FALSE, message=FALSE, out.width="50%"}
# plot raster with cvl boundaries
ggplot() +
  geom_raster(data = tree_df, aes(x = x, y = y, fill = tree_can)) + 
  scale_fill_viridis_c() +
  geom_sf(data = cvltracts, color = "red", fill = NA)
```

```{r, warning=FALSE, message=FALSE}
tree_extract <- raster::extract(tree, cvltracts, df = TRUE)
names(tree_extract) <- c("tract", "tree_can")


# the above keeps all cell values within a polygon
# check variation within tracts/spatial units
tree_extract %>% group_by(tract) %>% 
  summarize(cells = n(), 
            miss = sum(is.na(tree_can)),
            mean = mean(tree_can, na.rm = TRUE), 
            std = sd(tree_can, na.rm = TRUE))
```

```{r, include=F}
tree_extract$area_name <- 0
tree_extract$area_name[1:2411] <- "Seminole Square"
tree_extract$area_name[2411:3757] <- "Barracks Shopping Center"
tree_extract$area_name[3757:7175] <- "Locust Grove"
tree_extract$area_name[7175:8242] <-"Rose Hill"
tree_extract$area_name[8242:10514] <- "10th and Page"
tree_extract$area_name[10514:12315] <- "The Mall"
tree_extract$area_name[12315:13690] <- "Riverview"
tree_extract$area_name[13690:15888] <- "Jefferson Park Ave"
tree_extract$area_name[15888:16965] <- "Fifeville"
tree_extract$area_name[16965:21228] <- "Fry's Spring"
tree_extract$area_name[21228:25850] <- "West View Terrace"
tree_extract$area_name[25850:29539] <- "Belmont"
```

```{r, warning=FALSE, message=FALSE, out.width="50%"}

# is the mean a reasonable summary measure?
tree_extract %>% 
  ggplot(aes(x = tree_can)) + 
  geom_histogram() + 
  facet_wrap(~area_name)+
  theme(strip.background = element_blank())

# use the mean as the summary function for the moment
tree_mean <- raster::extract(tree, cvltracts, df = TRUE, 
                                 fun = mean, na.rm = TRUE,
                                 sp = TRUE)
# THIS WILL NEED TO CHANGE IF WE DECIDE NA's ARE ZEROS

# the above returned a spatal polygon object; change it back to sf
tree_tracts <- st_as_sf(tree_mean)
tree_tracts <- tree_tracts %>% 
  rename(tree_can = Charlottesville_NLCD_2016_Tree_Canopy_L48_nlcd)

ggplot() + 
  geom_sf(data = tree_tracts, aes(fill = tree_can)) +
  scale_fill_viridis_c()
```


#### Block Groups
```{r, include=F}
cvl_blocks <- block_groups("VA", "540")
```

```{r, warning=FALSE, message=FALSE}
tree_blk <- get_nlcd(
  template = cvl_blocks,
  label = "Charlottesville",
  dataset = "Tree_Canopy",
  year = 2016, 
  landmass = "L48"
)
```

```{r, include=F}
tree_df_blk <- as.data.frame(tree_blk, xy = TRUE)
names(tree_df_blk) <- c("x", "y", "tree_can")

ggplot(tree_df_blk, aes(x = tree_can)) + geom_histogram()

# reproject polygons to same CRS as tree
crs(tree_blk)
cvl_blocks <- st_transform(cvl_blocks, projection(tree_blk))
```

```{r, warning=FALSE, message=FALSE, out.width="50%"}
ggplot() +
  geom_raster(data = tree_df_blk, aes(x = x, y = y, fill = tree_can)) +
  scale_fill_viridis_c() +
  geom_sf(data = cvl_blocks, color = "red", fill = NA)
```

```{r, include=F}
tree_extract_blk <- raster::extract(tree_blk, cvl_blocks, df = TRUE)
names(tree_extract_blk) <- c("blocks", "tree_can")
```

```{r, warning=FALSE, message=FALSE}
# the above keeps all cell values within a polygon
# check variation within tracts/spatial units
tree_extract_blk %>% group_by(blocks) %>% 
  summarize(cells = n(), 
            miss = sum(is.na(tree_can)),
            mean = mean(tree_can, na.rm = TRUE), 
            std = sd(tree_can, na.rm = TRUE))

tree_extract_blk %>% 
  ggplot(aes(x = tree_can)) + 
  geom_histogram() + 
  facet_wrap(~blocks)+
  theme(strip.background = element_blank())
```

```{r, include=F}
# use the mean as the summary function for the moment
tree_mean_blk <- raster::extract(tree_blk, cvl_blocks, df = TRUE, 
                                 fun = mean, na.rm = TRUE,
                                 sp = TRUE)
# THIS WILL NEED TO CHANGE IF WE DECIDE NA's ARE ZEROS

# the above returned a spatal polygon object; change it back to sf
tree_blocks <- st_as_sf(tree_mean_blk)
tree_blocks <- tree_blocks %>% 
  rename(tree_can = Charlottesville_NLCD_2016_Tree_Canopy_L48_nlcd)
```

```{r, warning=FALSE, message=FALSE, out.width="50%"}
ggplot() + 
  geom_sf(data = tree_blocks, aes(fill = tree_can)) +
  scale_fill_viridis_c()
```

## Next Steps

* Build a comprehensive data frame (.csv) that derives variables (imperviousness) by relevant spatial units. (tracks/blocks)


