---
title: "Charlottesville Region Broadband Availability"
author: "Lee LeBoeuf"
date: "7/30/2021"
output: 
  html_document:
    toc: yes
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
invisible(lapply(list('tidyverse', 'stargazer', 'janitor', 'tigris', 'sf', 'leaflet', 'rcartocolor', 
                      'RColorBrewer', 'viridis', 'rgdal', 'lodes', 'psych', 'reshape2', 'googlesheets4', 
                      'sp', 'geosphere', 'stringr'),
                 function(pkg) library(pkg, character.only = TRUE)))
meta <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit?usp=sharing", sheet = "fcc_broadband", gs4_deauth())
cvldat <- read.csv("fcc_broadband_cville_tract.csv")
```

## Data Source
* These data come from the FCC's data on broadband availability. 
* FCC data is released biannually on a year and half delay from when it was collected. New data can be downloaded from this [link](https://www.fcc.gov/general/broadband-deployment-data-fcc-form-477). 
* Data presented here are from June of 2020. 

## Data specifics 
* All internet providers must submit form 477 to the FCC biannually detailing the Maximum download and upload speeds (Mbps) they advertise to consumers along with other information about the company. 
* The FCC makes these data publicly available on a year and a half delay from when all 477 forms are submitted. 
    + Limitations: (1) The data are available at the census block level, but are likely to overstate coverage because if an internet provider provides internet to a single person in a census block, the entire census block is marked as having coverage by that provider. 
    + Strengths: (1) These are the same data used by the government to make policy decisions regarding broadband access. (2) Trump signed an [act into law](https://www.commerce.senate.gov/2020/3/bill-to-improve-broadband-data-maps-signed-into-law) in March of 2020 that is supposed to improve the limitation listed above. 
    
## Variable descriptions
```{r}
meta %>% 
  filter(su_tract == 1) %>%
  select(varname, about) %>% as.list()
glimpse(cvldat)
cvldat %>% select(consproviders, busproviders, avgMaxAdDown, avgMaxAdUp, p_under25.3mbps) %>% 
  select(where(~is.numeric(.x))) %>% 
  as.data.frame() %>% 
  stargazer(., type = "text", title = "Summary Statistics", digits = 2,
            summary.stat = c("mean", "sd", "min", "median", "max"))
```

## Visual distribution 
```{r}
cvldat %>% select(c(tract, consproviders, busproviders, avgMaxAdDown, avgMaxAdUp, p_under25.3mbps)) %>% 
  pivot_longer(-tract, names_to = "measure", values_to = "value") %>%
  ggplot(aes(x = value, fill = measure)) +
  scale_fill_viridis(option = "plasma", discrete = TRUE, guide = FALSE) +
  geom_histogram() + 
  facet_wrap(~measure, scales = "free")
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("consproviders", "busproviders", "avgMaxAdDown", "avgMaxAdUp", "p_under25.3mbps")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
```
   
## Mapping the data 
```{r, echo = FALSE}
shape <- readRDS('cville_tracts.RDS')
shape <- st_transform(shape, crs = 4326) # to WGS84, given error
shape <- shape %>% dplyr::rename(tract = GEOID)
mapdat <- merge(shape, cvldat, by = 'tract', all.x = T)
```
  
### Number of consumer internet providers
```{r }
pal <- colorNumeric("plasma", reverse = TRUE, domain = mapdat$consproviders)

leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = mapdat,
              fillColor = ~pal(consproviders),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.8,
                bringToFront = T
              ),
              popup = paste0("GEOID: ", mapdat$tract, "<br>",
                             "Number of internet providers: ", mapdat$consproviders)
  ) %>% 
  addLegend("bottomright", pal = pal, values = mapdat$consproviders, 
            title = "Number of internet <br> providers", opacity = 0.7)
```

### Average maximum advertised download speeds 
```{r }
pal <- colorNumeric("plasma", reverse = TRUE, domain = mapdat$avgMaxAdDown) 

leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = mapdat,
              fillColor = ~pal(avgMaxAdDown),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.8,
                bringToFront = T
              ),
              popup = paste0("GEOID: ", mapdat$tract, "<br>",
                             "Average max advertised <br> download speeds: ", round(mapdat$avgMaxAdDown, 2))
  ) %>% 
  addLegend("bottomright", pal = pal, values = mapdat$avgMaxAdDown, 
            title = "Average maximum <br>advertised  <br>download speeds", opacity = 0.7)
```

### Average maximum advertised upload speeds 
```{r }
pal <- colorNumeric("plasma", reverse = TRUE, domain = mapdat$avgMaxAdUp)

leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = mapdat,
              fillColor = ~pal(avgMaxAdUp),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.8,
                bringToFront = T
              ),
              popup = paste0("GEOID: ", mapdat$tract, "<br>",
                             "Average max <br> advertised upload speeds: ", round(mapdat$avgMaxAdUp, 2))
  ) %>% 
  addLegend("bottomright", pal = pal, values = mapdat$avgMaxAdUp, 
            title = "Average maximum <br>advertised <br> upload speeds", opacity = 0.7)
```

### Percent of blocks that don't meet the FCC threshold for "advanced telecommunications capability"
* Percent of blocks in the spatial unit that do not meet the 25/3 Mbps bandwidth based on their providers' average maximum advertised download and upload speeds 
```{r }
pal <- colorNumeric("plasma", reverse = TRUE, domain = (mapdat$p_under25.3mbps *100))

leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = mapdat,
              fillColor = ~pal((mapdat$p_under25.3mbps *100)),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.8,
                bringToFront = T
              ),
              popup = paste0("GEOID: ", mapdat$tract, "<br>",
                             "Percent of blocks  <br>without advanced  <br>telecommunications capability: ", round((mapdat$p_under25.3mbps *100), 2))
  ) %>% 
  addLegend("bottomright", pal = pal, values = (mapdat$p_under25.3mbps *100), 
            title = "Percent of blocks  <br>without advanced  <br>telecommunications capability", opacity = 0.7)
```

