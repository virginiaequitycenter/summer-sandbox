---
title: "LEHD LODES"
subtitle: "Charlottesville Region 2018 Commuting Data"
author: "Lee LeBoeuf"
date: "07/29/2021"
output: 
  html_document:
    toc: yes
    toc_float: true
---

```{r libraries, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
invisible(lapply(list('tidyverse', 'stargazer', 'janitor', 'tigris', 'sf', 'leaflet', 'rcartocolor', 
                      'RColorBrewer', 'viridis', 'rgdal', 'lodes', 'psych', 'reshape2', 'googlesheets4', 
                      'sp', 'geosphere', 'stringr'),
                 function(pkg) library(pkg, character.only = TRUE)))
lodes <- read.csv("lodes_commute_cville_block.csv")
meta <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit?usp=sharing", sheet = "lehd_lodes_commute", gs4_deauth())
```

## Data source 
* Data structure description: https://lehd.ces.census.gov/data/lodes/LODES7/LODESTechDoc7.5.pdf
* Data download: https://lehd.ces.census.gov/data/lodes/LODES7/va/
* Helpful article about how these data are collected and how they can be used: https://www.researchgate.net/publication/328700665_The_US_Census_Longitudinal_Employer-Household_Dynamics_Datasets

## Data specifics
* The Longitudinal Employer Household Dynamics (LEHD) program at the US Census Bureau releases the Origin Destination Employment Statistis (LODES) datasets annually based on employer-employee insurance records. 
* This datafile uses data from the Origin-Destination (OD) data files from LEHD. The OD datafile lists each pair the census blocks for where workers live and work, enabling us to calculate the average commute distance by calculating the distance between each home and workplace census block pairing. 
* Distance calculations: All distances are "as the crow flies" and calulated using the Vincenty Ellipsoid method based on the latitude and longitudes of the centroids of each census block. These distances are then aggregated to the census block group and tract level.
* Data presented here are from 2018 and spatial units are based on the 2010 census. As of July of 2021, 2018 is the most recent year for which data are available. The earliest year for which data are available is 2002. 
* The data contains average and median commute distances for each SU calculated based on the following groups: (1) People who live *and* work in the Charlottesville region; (2) Charlottesville area residents who work within 40 miles of their home census block; (3) Charlottesville area residents who work in a tract outside the Charlottesville area that employs at least 25 Charlottsville area residents; (4) All Charlottesville area residents represented in the LODES OD data. The data also contains the number of residents within each SU who fall into those 4 categories. 
* Some limitations: 
    + The data are prone to imperfect geocoding for certain jobs; jobs for companies with multiple branches are often all coded in the same location. This means that distance calculations are likely to be an overestimate if many residents within one SU are employed by a company with multiple branches or a company whose headquarters is far away. There is also no way to differentiate between remote workers or the frequency with which any worker actually travels to their place of emplyoment (though note: these data were collected prior to the COVID-19 pandemic when fewer people were working remotely). For these reasons, we include calculations of average and median commute distances based on multiple groups of workers. The estimates based on all residents in an SU are most likely to be an overestimate, while those based on residents working within 40 miles of home are likely to be the most conservative. 
    + The distances are "as the crow flies" and therefore imprecise estimates of actual commute distances on the road. 
    + These data do not include workers in defense-related industries. 
    + Student-workers are unlikely to be represented in these data because their jobs are not typically covered by state unemployment insurance. 

## Variable descriptions
```{r}
meta %>% 
  filter(su_block == 1) %>%
  select(varname, about) %>% as.list()
glimpse(lodes)
lodes %>% select(avgc_all, avgc_within40, avgc_25_employees, avgc_workinRegion, medc_all, medc_within40, medc_25_employees, medc_workinRegion) %>% 
  select(where(~is.numeric(.x))) %>% 
  as.data.frame() %>% 
  stargazer(., type = "text", title = "Summary Statistics", digits = 2,
            summary.stat = c("mean", "sd", "min", "median", "max"))
```

## Visual distribution 
```{r}
long <- lodes %>% select(c( h_geocode, avgc_all, avgc_within40, avgc_25_employees, avgc_workinRegion, medc_all, medc_within40, medc_25_employees, medc_workinRegion)) %>% 
  pivot_longer(-h_geocode, names_to = "measure", values_to = "value")
long$measure <- factor(long$measure,
                         levels = c("avgc_all", "medc_all", "avgc_within40", "medc_within40", "avgc_25_employees", "medc_25_employees", "avgc_workinRegion",
                                    "medc_workinRegion"))
long %>% 
  ggplot(aes(x = value, fill = measure)) +
  scale_fill_viridis(option = "plasma", discrete = TRUE, guide = FALSE) +
  geom_histogram() + 
  facet_wrap(~measure, scales = "free", ncol = 2)
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("avgc_all", "avgc_within40", "avgc_25_employees", "avgc_workinRegion", "medc_all", "medc_within40", "medc_25_employees", "medc_workinRegion")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
```

## Mapping the data 
```{r, echo = FALSE}
shape <- readRDS('cville_blocks.RDS')
shape <- st_transform(shape, crs = 4326) # to WGS84, given error
shape <- shape %>% dplyr::rename(h_geocode = GEOID10)
cvl_lodes <- merge(shape, lodes, by = 'h_geocode', all.x = T)
```

### All Charlottesville region workers
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodes$avgc_all)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(avgc_all),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$h_geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodes$avgc_all, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$avgc_all, 
            title = "Average commute (mi)", opacity = 0.7)
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("avgc_all")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
``` 

### Charlottesvile region workers who work within 40 miles of home
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodes$avgc_within40)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(avgc_within40),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$h_geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodes$avgc_within40, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$avgc_within40, 
            title = "Average commute (mi)", opacity = 0.7)
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("avgc_within40")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
```

### Charlottesvile region workers who work in a tract that employs >=25 Charlottesville region residents
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodes$avgc_25_employees)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(avgc_25_employees),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$h_geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodes$avgc_25_employees, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$avgc_25_employees, 
            title = "Average commute (mi)", opacity = 0.7)
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("avgc_25_employees")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
```

### Charlottesville region only
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodes$avgc_workinRegion)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(avgc_workinRegion),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$h_geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodes$avgc_workinRegion, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$avgc_workinRegion, 
            title = "Average commute (mi)", opacity = 0.7)
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("avgc_workinRegion")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
```












