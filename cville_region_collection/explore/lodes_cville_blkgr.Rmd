---
title: "LEHD LODES"
subtitle: "Charlottesville Region 2018 Data"
author: "Lee LeBoeuf"
date: "07/20/2021"
output: 
  html_document:
    toc: yes
    toc_float: true
---

```{r libraries, include=FALSE}
invisible(lapply(list('tidyverse', 'stargazer', 'janitor', 'tigris', 'sf', 'leaflet', 'rcartocolor', 
                      'RColorBrewer', 'viridis', 'rgdal', 'lodes', 'psych', 'reshape2', 'googlesheets4', 'sp'),
                 function(pkg) library(pkg, character.only = TRUE)))
lodes <- read.csv("lodes_employment_cville_blkgr.csv")
meta <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit?usp=sharing", sheet = "lehd_lodes", gs4_deauth())
```

## Data source 
* Data structure description: https://lehd.ces.census.gov/data/lodes/LODES7/LODESTechDoc7.5.pdf
* Data download: https://lehd.ces.census.gov/data/lodes/LODES7/va/
* Helpful article about how these data are collected and how they can be used: https://www.researchgate.net/publication/328700665_The_US_Census_Longitudinal_Employer-Household_Dynamics_Datasets

## Data specifics
* The Longitudinal Employer Household Dynamics (LEHD) program at the US Census Bureau releases the Origin Destination Employment Statistis (LODES) datasets annually based on employer-employee insurance records. 
* This data file uses data from the Workplace Area Characteristics (WAC) datafile from LEHD. 
* Data presented here are from 2018 and spatial units are based on the 2010 census. As of July of 2021, 2018 is the most recent year for which data are available. The earliest year for which data are available is 2002. 
* The data contains the number of jobs within a spatial unit (SU), disaggregated by wage earnings, education-attainment of the worker, and race of the worker (all of which were pulled from the WAC data file)
* Some limitations: jobs counts do not include those working in defense-related industries; the data are prone to imperfect geocoding for certain jobs (jobs for companies with multiple branches are often all coded in the same location); although there are datasets from 2002-2018, these data are not suitable for longitudinal analysis; and student-workers are unlikely to be represented in these data because their jobs are not typically covered by state unemployment insurance. 

## Variable descriptions
```{r}
meta %>% 
  filter(su_blkgp == 1) %>%
  select(varname, about) %>% as.list()
glimpse(lodes)
lodes %>% select(lowwage_jobs:Bach_AdvDeg_jobs) %>% 
  select(where(~is.numeric(.x))) %>% 
  as.data.frame() %>% 
  stargazer(., type = "text", title = "Summary Statistics", digits = 2,
            summary.stat = c("mean", "sd", "min", "median", "max"))
```

## Total jobs counts
```{r}
lodes %>% select(c(w_blkgroup:alljobs)) %>% 
  pivot_longer(-w_blkgroup, names_to = "measure", values_to = "value") %>% 
  ggplot(aes(x = value, fill = measure)) + 
  scale_fill_viridis(option = "plasma", discrete = TRUE, guide = FALSE) +
  geom_histogram() + 
  facet_wrap(~measure, scales = "free")
```

```{r, results = "asis"}
meta %>% 
  filter(varname %in% c("higwage_jobs", "lowwage_jobs", "midwage_jobs", "alljobs")) %>%
  mutate(label = paste0(varname, ": ", about)) %>% 
  select(label) %>% 
  as.list()
```

## Mapping the data 
```{r, echo = FALSE}
shape <- readRDS('cville_blkgps.RDS')
shape <- st_transform(shape, crs = 4326) # to WGS84, given error
shape <- shape %>% dplyr::rename(w_blkgroup = GEOID)
is.element(lodes$w_blkgroup, shape$w_blkgroup) %>%
  all()
cvl_lodes <- merge(shape, lodes, by = 'w_blkgroup', all.x = T)
```

### All jobs
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_lodes$alljobs)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(alljobs),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$w_blkgroup, "<br>",
                             "Number of jobs: ", cvl_lodes$alljobs, 2)) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$alljobs, 
            title = "Number of jobs", opacity = 0.7)
```

### Wages

#### Proportion of low-wage jobs (earnings $1250/month or less) in each SU

```{r}
pal <- colorNumeric("BuPu", domain = cvl_lodes$lowwage_p)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(lowwage_p),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
                ),
              popup = paste0("GEOID: ", cvl_lodes$w_blkgroup, "<br>",
               "Prop. low-wage jobs: ", round(cvl_lodes$lowwage_p, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$lowwage_p, 
            title = "Proportion of <br> low-wage jobs", opacity = 0.7)
```

#### Proportion of high-wage jobs (earnings greater than $3333/month) in each SU

```{r}
pal <- colorNumeric("BuPu", domain = cvl_lodes$higwage_p)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(higwage_p),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              smoothFactor = 0.3,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$w_blkgroup, "<br>",
                             "Prop. high-wage jobs: ", round(cvl_lodes$higwage_p, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$higwage_p, 
            title = "Proportion of <br> high-wage jobs", opacity = 0.7)
```

### Education

#### Number of jobs for college-educated workers in each SU

```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_lodes$Bach_AdvDeg_jobs)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(Bach_AdvDeg_jobs),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              smoothFactor = 0.3,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$w_blkgroup,  "<br>",
                             "Number of jobs: ", cvl_lodes$Bach_AdvDeg_jobs)) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$Bach_AdvDeg_jobs, 
            title = "Number of jobs for <br> college-educated workers", opacity = 0.7)
```

#### Number of jobs for high school-educated workers in each SU

```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_lodes$HSnoCollege_jobs)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(HSnoCollege_jobs),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              smoothFactor = 0.3,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodes$w_blkgroup,  "<br>",
                             "Number of jobs: ", cvl_lodes$HSnoCollege_jobs)) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$HSnoCollege_jobs, 
            title = "Number of jobs for <br> high school-educated <br> workers", opacity = 0.7)
```

