---
title: "LEHD LODES"
subtitle: "Charlottesville Region Block Group Data"
author: "Lee LeBoeuf"
date: "07/06/2021"
output: 
  html_document:
  toc: true
  toc_float: true
---

## Charlottesville region 2018 LODES data exploration

```{r libraries, include=FALSE}
source('https://raw.githubusercontent.com/jacob-gg/manager/main/R/loch_missingness_monster.R')
invisible(lapply(list('tidyverse', 'stargazer', 'janitor', 'tigris', 'sf', 'leaflet', 'rcartocolor', 
                      'RColorBrewer', 'viridis', 'rgdal', 'lodes', 'psych', 'reshape2', 'googlesheets4', 'sp'),
                 function(pkg) library(pkg, character.only = TRUE)))
lodes <- read.csv("lodes_employment_cville_blkgr.csv")
meta <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit?usp=sharing", sheet = "lehd_lodes", gs4_deauth())
```

## Data source 
* Data structure description: https://lehd.ces.census.gov/data/lodes/LODES7/LODESTechDoc7.5.pdf
* Data download: https://lehd.ces.census.gov/data/lodes/LODES7/va/
* Helpful article about how these data are collected and how they can be used: https://www.researchgate.net/publication/328700665_The_US_Census_Longitudinal_Employer-Household_Dynamics_Datasets

## Data specifics
* This data file is a combined version of the WAC and RAC data files from LEHD-LODES. WAC stands for Workplace Area Characteristics and RAC stands for Resident Area Characteristics.
* Data are from 2018 and spatial units are based on the 2010 census. 
* Some limitations: jobs counts do not include those working in defense-related industries, imperfect geocoding for certain jobs (jobs for companies with multiple branches are often all coded in the same location), and these data are not suitable for longitudinal analysis. 
* At the block group and tract level there are is no missing data, but these are aggregates of the block-level data, and there are blocks with missing data. 

## Variable descriptions
```{r}
meta %>% 
  filter(su_blkgp == 1) %>%
  select(description) %>% as.list()
glimpse(lodes)
lodes %>% select(lowwage_jobs:Bach_AdvDeg_jobs) %>% 
  select(where(~is.numeric(.x))) %>% 
  as.data.frame() %>% 
  stargazer(., type = "text", title = "Summary Statistics", digits = 2,
            summary.stat = c("mean", "sd", "min", "median", "max"))
```

## Histograms
```{r}
lodes %>% select(c(w_blkgroup:alljobs)) %>% 
  pivot_longer(-w_blkgroup, names_to = "measure", values_to = "value") %>% 
  ggplot(aes(x = value, fill = measure)) + 
  scale_fill_viridis(option = "plasma", discrete = TRUE, guide = FALSE) +
  geom_histogram() + 
  facet_wrap(~measure, scales = "free")
```

## Mapping the data 
```{r, echo = FALSE}
shape <- readRDS('cville_blkgps.RDS')
shape <- st_transform(shape, crs = 4326) # to WGS84, given error
shape <- shape %>% dplyr::rename(w_blkgroup = GEOID)
is.element(lodes$w_blkgroup, shape$w_blkgroup) %>%
  all()
cvl_lodes <- merge(shape, lodes, by = 'w_blkgroup', all.x = T)
```

### All jobs
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_lodes$alljobs)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(alljobs),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("Block Group: ", cvl_lodes$BLKGRPCE, "<br>",
                             "Number of jobs: ", cvl_lodes$alljobs, 2)) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$alljobs, 
            title = "Number of jobs", opacity = 0.7)
```

### Wages
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_lodes$lowwage_p)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(lowwage_p),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
                ),
              popup = paste0("Block Group: ", cvl_lodes$BLKGRPCE, "<br>",
               "Prop. low-wage jobs: ", round(cvl_lodes$lowwage_p, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$lowwage_p, 
            title = "Proportion of low wage jobs", opacity = 0.7)
```

```{r}
# High wage jobs
pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_lodes$higwage_p)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(higwage_p),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              smoothFactor = 0.3,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("Block Group: ", cvl_lodes$BLKGRPCE, "<br>",
                             "Prop. high-wage jobs: ", round(cvl_lodes$higwage_p, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$higwage_p, 
            title = "Proportion of high-wage jobs", opacity = 0.7)
```

# Education
```{r}
pal <- colorNumeric("plasma", reverse = TRUE, domain = cvl_lodes$Bach_AdvDeg_jobs)
leaflet(cvl_lodes) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodes,
              fillColor = ~pal(Bach_AdvDeg_jobs),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              smoothFactor = 0.3,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("Block Group: ", cvl_lodes$BLKGRPCE, "<br>",
                             "Number of jobs: ", cvl_lodes$Bach_AdvDeg_jobs)) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodes$Bach_AdvDeg_jobs, 
            title = "Number of jobs for college-educated workers", opacity = 0.7)
```



