title: "FEMA NFIP Claims --- Charlottesville"
author: "Khalila Karefa-Kargbo"
date: "06/30/2021"
```{r}
library(tidyverse)
library(mosaic)
library(reticulate)
library(stargazer)
library(googlesheets4)
library(tigris)
library(sf)
library(viridis)
library(leaflet)
library(rgdal)
```

# Get Data
Source: FEMA, NFIP Redacted Claims, last updated July 2020
* Source URL: [https://www.fema.gov/openfema-data-page/fima-nfip-redacted-claims]
* Download URL: [https://www.fema.gov/api/open/v1/FimaNfipClaims.csv]

```{r}
cville_claims <- read_csv("fema_nfip_cville_tract.csv")
cvillefips <- c("51540", "51003", "51065", "51079", "51109", "51125")
meta <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit#gid=5733069", sheet = 'fema_nfip')
```

# Exploration
```{r}
glimpse(cville_claims)
```

**Variables of Interest:** Number of flood claims in spatial unit & total amount paid on flood claims in spatial unit...

**\# of flood claims in spatial unit**
```{r}
cville_claims %>% count(censusTract)
#55 total observations
```

**Variable Descriptions:**
```{r}
meta %>%
  select(c(varname, about)) %>% 
  as.list()
```

**Missing data?**
```{r}
sum(is.na(cville_claims$amountPaidOnContentsClaim)) # 51 / 55  
sum(is.na(cville_claims$amountPaidOnBuildingClaim)) # 14 / 55
sum(is.na(cville_claims$totalBuildingInsuranceCoverage)) # 0
sum(is.na(cville_claims$totalContentsInsuranceCoverage))# 0
```
```{r}
prop(is.na(cville_claims$amountPaidOnContentsClaim)) #  92.72% 
prop(is.na(cville_claims$amountPaidOnBuildingClaim)) # 25.45%
prop(is.na(cville_claims$totalBuildingInsuranceCoverage)) # 0
prop(is.na(cville_claims$totalContentsInsuranceCoverage)) # 0 
```

-   could not find out the reason for the missing data, whether it was from lack of records or no money being paid for the claim (but I assume this would show up as a 0 and not NA, so still unclear)
-   I'll continue by using just the amountPaidOnBuildingClaim variable; I'll also making a note that there is ContentsClaim data as well wherever applicable (most likely not for this exploration, but maybe if we look at individual claim data)
- I'll also just use the totalBuilding... instead of adding building + contents to adjust for this (basically just going to ignore contents completely)

# Charlottesville summaries & visualizations
```{r}
# 5-number summary of the $ amount paid
cvilleClaimSum <- cville_claims %>%
  group_by(censusTract) %>%
  summarize(n = count(censusTract),
            avg_amt = mean(amountPaidOnBuildingClaim, na.rm = TRUE),
            med_amt = median(amountPaidOnBuildingClaim, na.rm = TRUE),
            sd_amt = sd(amountPaidOnBuildingClaim, na.rm = TRUE),
            min_amt = min(amountPaidOnBuildingClaim, na.rm = TRUE),
            max_amt = max(amountPaidOnBuildingClaim, na.rm = TRUE))
print(cvilleClaimSum)
```
```{r}
# 5-number summary of the total insurance amount
cvilleTotalSum <- cville_claims %>%
  group_by(censusTract) %>%
  summarize(n = count(censusTract),
            avg_amt = mean(totalBuildingInsuranceCoverage, na.rm = TRUE),
            med_amt = median(totalBuildingInsuranceCoverage, na.rm = TRUE),
            sd_amt = sd(totalBuildingInsuranceCoverage, na.rm = TRUE),
            min_amt = min(totalBuildingInsuranceCoverage, na.rm = TRUE),
            max_amt = max(totalBuildingInsuranceCoverage, na.rm = TRUE))
print(cvilleTotalSum)
```

```{r}
# difference between amount covered and amount paid 
cville_claims %>% 
  diffmean <- mean("totalBuildingInsuranceCoverage", na.rm = TRUE) - mean("amountPaidOnBuildingClaim", na.rm = TRUE)
####fix errors####
```

```{r}
###difference between means
```

# Visual distributions
```{r}
# barplot of the average building amount paid by census tract
ggplot(cvilleClaimSum) + 
  geom_col(aes(x=censusTract, y=avg_amt, color=censusTract))
```
```{r}
# barplot of the average building insurance coverage by census tract
ggplot(cvilleTotalSum) + 
  geom_col(aes(x=censusTract, y=avg_amt, color=censusTract))
```

# Maps
**Get Data**
```{r}
vacounties <- counties(state="VA")

cvl_alb <- vacounties %>% 
  filter(COUNTYFP %in% c("003", "540", "065", "125", "079", "109"))

sp::plot(cvl_alb[1], col="firebrick", border=TRUE)

```

**Building Amount Paid Map**
```{r}
#spatial intersection of amount paid on building claim over polygon

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(data = cvl_alb)
```
LEFT TO-DO:
- get on census tract level instead of county
- make sure its using the same coordinate system (doesn't seem to be: inconsistent datum error) (st_transform...)
- intersect claims data 
- addLegend

**Total Building Insurance Amount Map**
```{r}
#working on it
```

# Miscellaneuos

[This](https://www.fema.gov/about/openfema/data-sets#misc) is a list of all of FEMA's open data sets and could be helpful

[claim manual](https://www.fema.gov/sites/default/files/2020-07/fema_nfip_claims-manual_2020.pdf) that gives a little more details on how claims are filed (might not be that helpful though)

**Other potential variables of interest:**
- **baseFloodElevation:** Base Flood Elevation (BFE) is the elevation at which there is a 1% chance per year of flooding in feet from the elevation certificate