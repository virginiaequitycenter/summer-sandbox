---
title: "LEHD LODES"
subtitle: "Charlottesville Region 2018 Commuting Data"
author: "Lee LeBoeuf"
date: "09/06/2021"
output: 
  html_document:
    toc: yes
    toc_float: true
---

```{r libraries, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
invisible(lapply(list('tidyverse', 'stargazer', 'janitor', 'tigris', 'sf', 'leaflet', 'rcartocolor', 
                      'RColorBrewer', 'viridis', 'rgdal', 'lodes', 'psych', 'reshape2', 'googlesheets4', 
                      'sp', 'geosphere', 'stringr'),
                 function(pkg) library(pkg, character.only = TRUE)))
lodesresidents <- read.csv("lodes_commute_cville_tract.csv")
lodesworkers <- read.csv("lodes_workerscommute_cville_tract.csv")
metaresidents <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit?usp=sharing", sheet = "lehd_lodes_rescommute", gs4_deauth())
metaworkers <- read_sheet("https://docs.google.com/spreadsheets/d/1nqm3DuVXD1ObbVe_deacvT7uSLdBXfQJo3mkbqDwrVo/edit?usp=sharing", sheet = "lehd_lodes_workcommute", gs4_deauth())
```

## Data source 
* Data structure description: https://lehd.ces.census.gov/data/lodes/LODES7/LODESTechDoc7.5.pdf
* Data download: https://lehd.ces.census.gov/data/lodes/LODES7/va/
* Helpful article about how these data are collected and how they can be used: https://www.researchgate.net/publication/328700665_The_US_Census_Longitudinal_Employer-Household_Dynamics_Datasets

## Data specifics
* The Longitudinal Employer Household Dynamics (LEHD) program at the US Census Bureau releases the Origin Destination Employment Statistis (LODES) datasets annually based on employer-employee insurance records. 
* This datafile uses data from the Origin-Destination (OD) data files from LEHD. The OD datafile lists each pair the census blocks for where workers live and work, enabling us to calculate the average commute distance by calculating the distance between each home and workplace census block pairing. 
* Distance calculations: All distances are "as the crow flies" and calulated using the Vincenty Ellipsoid method based on the latitude and longitudes of the centroids of each census block. These distances are then aggregated to the census block group and tract level. Distances are likely to be an underestimate of actual road travel. 
* Data presented here are from 2018 and spatial units are based on the 2010 census. As of July of 2021, 2018 is the most recent year for which data are available. The earliest year for which data are available is 2002. 
* There are two datafiles presented here:
    + Charlottesville region residents: The first contains average and median commute distances for each SU calculated based on the following groups: (1) People who live *and* work in the Charlottesville region; (2) Charlottesville area residents who work within 40 miles of their home census block; (3) Charlottesville area residents who work in a tract outside the Charlottesville area that employs at least 25 Charlottsville area residents; (4) All Charlottesville area residents represented in the LODES OD data. The data also contains the number of residents within each SU who fall into those 4 categories. 
    + Charlottesville region workers: The second contains average and median commute distnaces for each SU calculated based on the following groups:(1) Charlottesville area workers who live within 40 miles of their work-place census block; (2) Charlottesville area workers who live in a tract that (a) is outside the Charlottesville area and (b) is home to 25 or more Cville workers; and (3) All Charlottesville area workers represented in the data. This data file also contains the percent of workers in each SU that live outside the Charlottesville region. 
* Some limitations: 
    + The data are prone to imperfect geocoding for certain jobs; jobs for companies with multiple branches are often all coded in the same location. This means that distance calculations are likely to be an overestimate if many residents within one SU are employed by a company with multiple branches or a company whose headquarters is far away. There is also no way to differentiate between remote workers or the frequency with which any worker actually travels to their place of emplyoment (note: these data were collected prior to the COVID-19 pandemic when fewer people were working remotely). For these reasons, we include calculations of average and median commute distances based on multiple groups of workers. The estimates based on all residents in an SU are most likely to be an overestimate, while those based on residents working within 40 miles of home are likely to be the most conservative. 
    + The distances are "as the crow flies" and therefore imprecise estimates of actual commute distances on the road. 
    + These data do not include workers in defense-related industries. 
    + Student-workers are unlikely to be represented in these data because their jobs are not typically covered by state unemployment insurance. 

## Data preview {.tabset}

### Charlottesville Area residents {.tabset}
```{r}
glimpse(lodesresidents)
```

### Charlottesville Area workers
```{r}
glimpse(lodesworkers)
```

## Variable descriptions {.tabset}

### Charlottesville Area residents {.tabset}
```{r}
metaresidents %>% 
  filter(su_tract == 1) %>%
  select(varname, about) %>% as.list()
```

### Charlottesville Area workers
```{r}
metaworkers %>% 
  filter(su_tract == 1) %>%
  select(varname, about) %>% as.list()
```

## Variable descriptives {.tabset}

### Charlottesville Area residents {.tabset}
```{r}
lodesresidents %>% select(avgc_alltr, avgc_within40tr, avgc_25_employeestr, avgc_workinRegiontr, medc_alltr, medc_within40tr, medc_25_employeestr, medc_workinRegiontr) %>% 
  select(where(~is.numeric(.x))) %>% 
  as.data.frame() %>% 
  stargazer(., type = "text", title = "Summary Statistics", digits = 2,
            summary.stat = c("mean", "sd", "min", "median", "max"))
```

### Charlottesville Area workers
```{r}
lodesworkers %>% select(avgc_allworkerstr, avgc_livewithin40tr, avgc_25_restr, medc_allworkerstr, medc_livewithin40tr, medc_25_restr, perc_workers_liveoutsideCvilletr) %>% 
  select(where(~is.numeric(.x))) %>% 
  as.data.frame() %>% 
  stargazer(., type = "text", title = "Summary Statistics", digits = 2,
            summary.stat = c("mean", "sd", "min", "median", "max"))
```

## Visual distribution {.tabset}

### Charlottesville Area residents {.tabset}
```{r}
longr <- lodesresidents %>% select(c(tract, avgc_alltr, avgc_within40tr, avgc_25_employeestr, avgc_workinRegiontr, medc_alltr, medc_within40tr, medc_25_employeestr, medc_workinRegiontr)) %>% 
  pivot_longer(-tract, names_to = "measure", values_to = "value")
longr$measure <- factor(longr$measure,
                         levels = c("avgc_alltr", "medc_alltr", "avgc_within40tr", "medc_within40tr", "avgc_25_employeestr", "medc_25_employeestr", "avgc_workinRegiontr",
                                    "medc_workinRegiontr"))
longr %>% 
  ggplot(aes(x = value, fill = measure)) +
  scale_fill_viridis(option = "plasma", discrete = TRUE, guide = FALSE) +
  geom_histogram() + 
  facet_wrap(~measure, scales = "free", ncol = 2)
```

### Charlottesville Area workers
```{r}
longw <- lodesworkers %>% select(c(tract, avgc_allworkerstr, avgc_livewithin40tr, avgc_25_restr, medc_allworkerstr, medc_livewithin40tr, medc_25_restr)) %>% 
  pivot_longer(-tract, names_to = "measure", values_to = "value")
longw$measure <- factor(longw$measure,
                         levels = c("avgc_allworkerstr", "medc_allworkerstr", "avgc_livewithin40tr", "medc_livewithin40tr", "avgc_25_restr", "medc_25_restr"))
longw %>% 
  ggplot(aes(x = value, fill = measure)) +
  scale_fill_viridis(option = "plasma", discrete = TRUE, guide = FALSE) +
  geom_histogram() + 
  facet_wrap(~measure, scales = "free", ncol = 2)
```

## Mapping the data 
```{r, echo = FALSE}
shape <- readRDS('cville_tracts.RDS')
shape <- st_transform(shape, crs = 4326) # to WGS84, given error
shape <- shape %>% dplyr::rename(geocode = GEOID)
lodesworkers <- lodesworkers %>% rename(geocode = tract)
lodesresidents <- lodesresidents %>% rename(geocode = tract)
cvl_lodes1 <- merge(shape, lodesresidents, by = 'geocode', all.x = T)
cvl_lodesfull <- merge(cvl_lodes1, lodesworkers, by = 'geocode', all.x = T)
```

### Full data {.tabset}

#### All Cville area residents {.tabset}
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodesfull$avgc_alltr)
leaflet(cvl_lodesfull) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodesfull,
              fillColor = ~pal(avgc_alltr),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodesfull$geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodesfull$avgc_alltr, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodesfull$avgc_alltr, 
            title = "Average commute (mi)", opacity = 0.7)
```

#### All Cville area workers {.tabset}
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodesfull$avgc_allworkerstr)
leaflet(cvl_lodesfull) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodesfull,
              fillColor = ~pal(avgc_allworkerstr),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodesfull$geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodesfull$avgc_allworkerstr, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodesfull$avgc_allworkerstr, 
            title = "Average commute (mi)", opacity = 0.7)
```

### Within 40 miles {.tabset}

#### Cville area residents who work within 40 miles of home {.tabset}
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodesfull$avgc_within40tr)
leaflet(cvl_lodesfull) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodesfull,
              fillColor = ~pal(avgc_within40tr),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodesfull$geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodesfull$avgc_within40tr, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodesfull$avgc_within40tr, 
            title = "Average commute (mi)", opacity = 0.7)
```

#### Cville area workers who live within 40 miles of work {.tabset}
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodesfull$avgc_livewithin40tr)
leaflet(cvl_lodesfull) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodesfull,
              fillColor = ~pal(avgc_livewithin40tr),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodesfull$geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodesfull$avgc_livewithin40tr, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodesfull$avgc_livewithin40tr, 
            title = "Average commute (mi)", opacity = 0.7)
```

### Cville area residents and workers only

* Average commute distances for people who work __and__ live in the Charlottesville region

```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodesfull$avgc_workinRegiontr)
leaflet(cvl_lodesfull) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodesfull,
              fillColor = ~pal(avgc_workinRegiontr),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodesfull$geocode, "<br>",
                             "Average commute (mi): ", round(cvl_lodesfull$avgc_workinRegiontr, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodesfull$avgc_workinRegiontr, 
            title = "Average commute (mi)", opacity = 0.7)
```

### Percent of workers who live outside the Charlottesville region
```{r}
pal <- colorNumeric("plasma", reverse = T, domain = cvl_lodesfull$perc_workers_liveoutsideCvilletr)
leaflet(cvl_lodesfull) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(data = cvl_lodesfull,
              fillColor = ~pal(perc_workers_liveoutsideCvilletr),
              weight = 1,
              opacity = 1,
              color = "white", 
              fillOpacity = 0.6,
              highlight = highlightOptions(
                weight = 1, fillOpacity = 0.8, bringToFront = T
              ),
              popup = paste0("GEOID: ", cvl_lodesfull$geocode, "<br>",
                             "Percent of workers: ", round(cvl_lodesfull$perc_workers_liveoutsideCvilletr, 2))) %>% 
  addLegend("bottomright", pal = pal, values = cvl_lodesfull$perc_workers_liveoutsideCvilletr, 
            title = "Percent of workers <br> who live outside Cville <br> region", opacity = 0.7)
```

